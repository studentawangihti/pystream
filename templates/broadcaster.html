<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Broadcaster Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .mirrored {
        transform: scaleX(-1);
      }
      ::-webkit-scrollbar {
        display: none;
      }

      /* Custom Range Slider */
      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 18px;
        width: 18px;
        border-radius: 50%;
        background: #fbbf24;
        border: 2px solid #1f2937;
        margin-top: -7px;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #4b5563;
        border-radius: 2px;
      }

      /* UI Fade Transitions */
      .ui-fade {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .ui-hidden-desktop {
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>
  <body
    class="bg-black text-white h-screen w-screen overflow-hidden font-sans select-none"
    id="bodyEl"
  >
    <div
      id="topBar"
      class="absolute top-0 left-0 w-full p-4 md:p-6 flex justify-between items-start z-20 ui-fade bg-gradient-to-b from-black/80 to-transparent md:bg-none pointer-events-none"
    >
      <div
        class="flex flex-col md:flex-row gap-2 md:gap-4 items-start md:items-center"
      >
        <div
          class="bg-black/60 backdrop-blur px-3 py-1.5 rounded-full border border-gray-700 text-gray-300 text-[10px] font-mono inline-flex items-center gap-1 w-max shadow-lg"
        >
          <div
            class="w-2 h-2 rounded-full bg-gray-500 transition-colors"
            id="statusDot"
          ></div>
          <span id="status">OFFLINE</span>
        </div>
        <div class="flex gap-1">
          <div
            class="bg-black/60 backdrop-blur px-2 py-1 rounded-full border border-blue-900/50 text-blue-300 text-[10px] font-mono block w-max shadow-lg"
          >
            ‚ñ≤ <span id="bitrate">0</span>k
          </div>
          <div
            class="bg-black/60 backdrop-blur px-2 py-1 rounded-full border border-purple-900/50 text-purple-300 text-[10px] font-mono block w-max shadow-lg"
          >
            ‚öôÔ∏è <span id="resDisplay">Auto</span>
          </div>
        </div>
      </div>

      <div class="flex gap-2 pointer-events-auto">
        <a
          href="/"
          class="bg-gray-800/80 hover:bg-gray-700 p-0 rounded-full border border-gray-600 transition w-10 h-10 flex items-center justify-center text-white shadow-lg text-lg"
          title="Back to Home"
        >
          üè†
        </a>

        <button
          onclick="toggleMirror()"
          class="bg-gray-800/80 hover:bg-gray-700 p-0 rounded-full border border-gray-600 transition w-10 h-10 flex items-center justify-center text-lg shadow-lg"
          title="Mirror Video"
        >
          ü™û
        </button>

        <button
          onclick="toggleSettings()"
          class="bg-gray-800/80 hover:bg-gray-700 p-0 rounded-full border border-gray-600 transition w-10 h-10 flex items-center justify-center text-lg shadow-lg"
          title="Settings"
        >
          ‚öôÔ∏è
        </button>
      </div>
    </div>

    <div
      class="w-full h-full relative flex items-center justify-center bg-[#0a0a0a]"
    >
      <video
        id="localVideo"
        autoplay
        playsinline
        muted
        class="w-full h-full object-cover md:object-contain transition-transform duration-300"
      ></video>

      <div
        id="pauseOverlay"
        class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-10"
      >
        <span class="text-5xl mb-4">‚è∏Ô∏è</span>
        <h2 class="text-2xl font-bold tracking-widest text-gray-400">PAUSED</h2>
        <p class="text-xs text-gray-600 mt-2">Audio Active</p>
      </div>

      <div
        id="focusPanel"
        class="hidden absolute left-4 md:left-auto md:right-6 top-1/2 -translate-y-1/2 bg-black/40 backdrop-blur p-3 md:p-4 rounded-full border border-white/10 flex flex-col items-center gap-4 z-20 pointer-events-auto"
      >
        <button
          onclick="setFocusMode('continuous')"
          class="w-8 h-8 rounded-full bg-blue-600 text-[8px] font-bold border border-white/10"
        >
          AF
        </button>
        <div class="h-32 md:h-40 w-2 flex items-center justify-center">
          <input
            type="range"
            id="focusSlider"
            min="0"
            max="100"
            step="0.1"
            class="w-32 md:w-40 -rotate-90 origin-center cursor-pointer opacity-80"
            oninput="manualFocus(this.value)"
          />
        </div>
      </div>
    </div>

    <button
      id="btnShowUI"
      onclick="toggleUI(true)"
      class="hidden absolute bottom-8 left-1/2 -translate-x-1/2 z-10 bg-black/60 backdrop-blur border border-white/20 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg hover:bg-black/80 transition transform translate-y-0 opacity-100 animate-bounce pointer-events-auto"
    >
      ‚ñ≤ Show Controls
    </button>

    <div
      id="controlDock"
      class="absolute bottom-0 md:bottom-8 left-0 md:left-1/2 md:-translate-x-1/2 w-full md:w-auto z-30 ui-fade pointer-events-auto"
    >
      <div
        class="bg-gray-900/95 md:bg-gray-900/80 backdrop-blur-md border-t md:border border-gray-700 rounded-t-3xl md:rounded-2xl px-6 py-4 md:px-8 md:py-4 flex flex-row items-center justify-between md:justify-center gap-4 md:gap-8 shadow-2xl transition-all"
      >
        <div
          class="absolute top-2 left-1/2 -translate-x-1/2 w-12 h-1 bg-gray-700 rounded-full md:hidden cursor-pointer"
          onclick="toggleUI(false)"
        ></div>

        <div class="flex gap-3 mt-2 md:mt-0">
          <button
            onclick="toggleMic()"
            id="btnMic"
            class="flex flex-col md:flex-row items-center gap-1 text-green-400 hover:text-white transition group"
          >
            <div
              class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-800 group-hover:bg-gray-700 border border-gray-600 flex items-center justify-center text-lg"
            >
              üé§
            </div>
            <span class="text-[9px] uppercase font-bold md:hidden">Mic</span>
          </button>
          <button
            onclick="toggleCam()"
            id="btnCam"
            class="flex flex-col md:flex-row items-center gap-1 text-green-400 hover:text-white transition group"
          >
            <div
              class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-800 group-hover:bg-gray-700 border border-gray-600 flex items-center justify-center text-lg"
            >
              üì∑
            </div>
            <span class="text-[9px] uppercase font-bold md:hidden">Cam</span>
          </button>
        </div>

        <div class="relative -top-6 md:top-0">
          <button
            onclick="toggleStream()"
            id="btnAction"
            class="bg-red-600 hover:bg-red-500 w-20 h-20 md:w-auto md:h-auto md:px-8 md:py-3 rounded-full md:rounded-xl font-bold text-white shadow-[0_0_20px_rgba(220,38,38,0.5)] border-4 border-gray-900 md:border-red-400 active:scale-95 transition flex items-center justify-center gap-2"
          >
            <span id="btnIcon" class="text-sm md:text-base">LIVE</span>
          </button>
        </div>

        <div class="flex gap-3 mt-2 md:mt-0">
          <button
            onclick="togglePause()"
            id="btnPause"
            class="flex flex-col md:flex-row items-center gap-1 text-gray-400 hover:text-white disabled:opacity-30 transition group"
            disabled
          >
            <div
              class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-800 group-hover:bg-gray-700 border border-gray-600 flex items-center justify-center text-lg"
            >
              ‚è∏Ô∏è
            </div>
            <span class="text-[9px] uppercase font-bold md:hidden">Pause</span>
          </button>

          <button
            onclick="toggleUI(false)"
            class="hidden md:flex flex-col md:flex-row items-center gap-1 text-gray-400 hover:text-white transition group"
            title="Hide Controls"
          >
            <div
              class="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-gray-800 group-hover:bg-gray-700 border border-gray-600 flex items-center justify-center text-lg"
            >
              ‚ñº
            </div>
          </button>
        </div>
      </div>
    </div>

    <div
      id="settingsPanel"
      class="hidden absolute inset-0 z-50 bg-black/90 backdrop-blur-md p-6 flex flex-col md:items-center md:justify-center animate-fade-in"
    >
      <div
        class="w-full max-w-2xl bg-gray-900 border border-gray-700 p-6 md:p-8 rounded-2xl shadow-2xl relative flex flex-col h-full md:h-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-white flex items-center gap-2">
            ‚öôÔ∏è Stream Config
          </h2>
          <button
            onclick="toggleSettings()"
            class="text-gray-400 hover:text-white text-3xl"
          >
            &times;
          </button>
        </div>

        <div class="space-y-6 overflow-y-auto flex-1">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-3"
              >Resolution</label
            >
            <div class="grid grid-cols-2 gap-3">
              <button
                onclick="selectRes(3840,2160, this)"
                class="res-btn bg-gray-800 p-4 rounded-xl text-sm border border-gray-700 font-bold transition hover:bg-gray-700"
              >
                4K UHD
              </button>
              <button
                onclick="selectRes(1920,1080, this)"
                class="res-btn bg-gray-800 p-4 rounded-xl text-sm border border-gray-700 font-bold transition hover:bg-gray-700"
              >
                1080p
              </button>
              <button
                onclick="selectRes(1280,720, this)"
                class="res-btn bg-blue-600 text-white p-4 rounded-xl text-sm border border-blue-500 shadow-lg font-bold transition hover:bg-blue-500"
              >
                720p (Rec)
              </button>
              <button
                onclick="selectRes(640,360, this)"
                class="res-btn bg-gray-800 p-4 rounded-xl text-sm border border-gray-700 font-bold transition hover:bg-gray-700"
              >
                360p
              </button>
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-3"
              >Framerate:
              <span id="fpsVal" class="text-white">30</span> FPS</label
            >
            <input
              type="range"
              id="fpsRange"
              min="24"
              max="60"
              value="30"
              step="1"
              class="w-full h-2 bg-gray-700 rounded-lg appearance-none"
              oninput="document.getElementById('fpsVal').innerText = this.value"
            />
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-3"
              >Camera Source</label
            >
            <select
              id="cameraSelect"
              class="w-full bg-gray-800 text-white p-4 rounded-xl border border-gray-600 focus:border-blue-500 outline-none text-sm"
            ></select>
          </div>

          <div class="bg-black/40 p-4 rounded-xl border border-gray-700">
            <label
              class="block text-xs font-bold text-purple-400 uppercase mb-2"
              >üîó OBS Browser Source Link</label
            >
            <div class="flex gap-2">
              <input
                type="text"
                id="obsUrlInput"
                readonly
                class="w-full bg-black/50 text-gray-300 text-xs p-3 rounded-lg border border-gray-700 font-mono select-all focus:outline-none"
                value="Loading..."
              />
              <button
                onclick="copyObsLink()"
                class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition whitespace-nowrap active:scale-95"
              >
                COPY
              </button>
            </div>
          </div>
        </div>

        <button
          onclick="applyConfig()"
          class="w-full mt-6 bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-white shadow-lg text-lg active:scale-[0.98] transition"
        >
          APPLY SETTINGS
        </button>
      </div>
    </div>

    <script>
      const socket = io();
      const room = "room1";
      const rtcConfig = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };

      let localStream, peerConnection;
      let isStreaming = false,
        isPaused = false,
        isMicOn = true,
        isCamOn = true;
      let currentRes = { w: 1280, h: 720 },
        currentFps = 30;
      let currentDeviceId = null;
      let uiTimeout;

      // DOM Elements
      const localVideo = document.getElementById("localVideo");
      const cameraSelect = document.getElementById("cameraSelect");
      const statusEl = document.getElementById("status");
      const statusDot = document.getElementById("statusDot");
      const bitrateEl = document.getElementById("bitrate");
      const resDisplay = document.getElementById("resDisplay");

      // --- 1. RESPONSIVE UI LOGIC ---
      // Only enable hover-to-show on desktop screens
      if (window.matchMedia("(min-width: 768px)").matches) {
        document.getElementById("bodyEl").addEventListener("mousemove", showUI);
      }

      function showUI() {
        // Show all UI elements
        ["topBar", "controlDock", "focusPanel"].forEach((id) =>
          document.getElementById(id).classList.remove("ui-hidden-desktop")
        );

        clearTimeout(uiTimeout);
        uiTimeout = setTimeout(() => {
          // If modal is NOT open, hide UI after 3 seconds
          if (
            document
              .getElementById("settingsPanel")
              .classList.contains("hidden")
          ) {
            ["topBar", "controlDock", "focusPanel"].forEach((id) =>
              document.getElementById(id).classList.add("ui-hidden-desktop")
            );
          }
        }, 3000);
      }

      function toggleUI(show) {
        const panel = document.getElementById("controlDock");
        const btn = document.getElementById("btnShowUI");
        if (show) {
          panel.classList.remove("translate-y-full", "opacity-0");
          btn.classList.add("hidden");
        } else {
          panel.classList.add("translate-y-full", "opacity-0");
          btn.classList.remove("hidden");
        }
      }

      // --- 2. BITRATE & CODEC HACKS ---
      function setMediaBitrate(sdp, bitrateKbps) {
        var lines = sdp.split("\n");
        var line = -1;
        for (var i = 0; i < lines.length; i++) {
          if (lines[i].indexOf("m=video") === 0) {
            line = i;
            break;
          }
        }
        if (line === -1) return sdp;
        line++;
        while (
          lines[line].indexOf("i=") === 0 ||
          lines[line].indexOf("c=") === 0
        )
          line++;
        if (lines[line].indexOf("b=AS:") === 0)
          lines[line] = "b=AS:" + bitrateKbps;
        else lines.splice(line, 0, "b=AS:" + bitrateKbps);
        return lines.join("\n");
      }

      function setCodecPreferences(pc) {
        const transceiver = pc
          .getTransceivers()
          .find((t) => t.sender.track === localStream.getVideoTracks()[0]);
        if (!transceiver || !RTCRtpReceiver.getCapabilities) return;
        const codecs = RTCRtpReceiver.getCapabilities("video").codecs;
        const preferred = [];
        // Prefer AV1 > VP9 > H264
        ["video/AV1", "video/VP9", "video/H264"].forEach((mime) =>
          preferred.push(...codecs.filter((c) => c.mimeType === mime))
        );
        codecs.forEach((c) => {
          if (!preferred.find((p) => p.mimeType === c.mimeType))
            preferred.push(c);
        });
        if (transceiver.setCodecPreferences)
          transceiver.setCodecPreferences(preferred);
      }

      // --- 3. INITIALIZATION ---
      async function init() {
        try {
          await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          await getCameras();
          await startPreview();
          initObsLink();
          if (window.innerWidth > 768) showUI(); // Show UI initially on desktop
        } catch (e) {
          alert("Camera Permission Required! Ensure HTTPS.");
        }
      }

      async function getCameras() {
        const devs = await navigator.mediaDevices.enumerateDevices();
        const vDevs = devs.filter((d) => d.kind === "videoinput");
        cameraSelect.innerHTML = "";
        vDevs.forEach((d) => {
          const o = document.createElement("option");
          o.value = d.deviceId;
          o.text = d.label || `Cam ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(o);
        });
      }

      async function startPreview(deviceId = null) {
        if (localStream) localStream.getTracks().forEach((t) => t.stop());

        let constraints = {
          audio: true,
          video: {
            width: { ideal: currentRes.w },
            height: { ideal: currentRes.h },
            frameRate: { ideal: currentFps },
            focusMode: "continuous",
          },
        };

        // Logic Camera Selection
        if (deviceId || currentDeviceId) {
          constraints.video.deviceId = {
            exact: deviceId || currentDeviceId || cameraSelect.value,
          };
        } else {
          constraints.video.facingMode = { ideal: "environment" }; // Default Back
        }

        try {
          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          localVideo.srcObject = localStream;

          const sett = localStream.getVideoTracks()[0].getSettings();

          // Mirror Logic: User (Front) = Mirror, Env (Back) = Normal
          if (sett.facingMode === "user") localVideo.classList.add("mirrored");
          else localVideo.classList.remove("mirrored");

          if (sett.deviceId) {
            cameraSelect.value = sett.deviceId;
            currentDeviceId = sett.deviceId;
          }
          if (sett.height)
            resDisplay.innerText = `${sett.height}p @ ${Math.round(
              sett.frameRate || currentFps
            )}`;

          checkFocus(localStream.getVideoTracks()[0]);
        } catch (e) {
          console.error(e);
        }
      }

      // --- 4. ACTIONS ---
      function toggleStream() {
        const btnAction = document.getElementById("btnAction");
        const btnIcon = document.getElementById("btnIcon");
        if (!isStreaming) {
          isStreaming = true;
          socket.emit("join", room);
          statusEl.innerText = "LIVE";
          statusEl.classList.replace("text-gray-400", "text-red-500");
          statusDot.classList.replace("bg-gray-500", "bg-red-500");
          statusDot.classList.add("animate-pulse");
          btnIcon.innerText = "STOP";
          btnAction.classList.add("bg-gray-800", "border-gray-600");
          btnAction.classList.remove("bg-red-600", "border-red-400");
          document.getElementById("btnPause").disabled = false;
          startBitrateCheck();
        } else {
          location.reload();
        }
      }

      function switchCamera() {
        // Full reset connection on camera switch
        if (peerConnection) peerConnection.close();
        startPreview(cameraSelect.value).then(() => {
          if (isStreaming) createOffer();
        });
      }

      function togglePause() {
        if (!localStream) return;
        isPaused = !isPaused;
        localStream.getVideoTracks()[0].enabled = !isPaused;
        document
          .getElementById("pauseOverlay")
          .classList.toggle("hidden", !isPaused);
      }

      function toggleMic() {
        isMicOn = !isMicOn;
        localStream.getAudioTracks()[0].enabled = isMicOn;
        const b = document.getElementById("btnMic");
        b.classList.toggle("text-green-400", isMicOn);
        b.classList.toggle("text-red-400", !isMicOn);
      }

      function toggleCam() {
        isCamOn = !isCamOn;
        localStream.getVideoTracks()[0].enabled = isCamOn;
        const b = document.getElementById("btnCam");
        b.classList.toggle("text-green-400", isCamOn);
        b.classList.toggle("text-red-400", !isCamOn);
      }

      function toggleMirror() {
        localVideo.classList.toggle("mirrored");
      }
      function toggleSettings() {
        document.getElementById("settingsPanel").classList.toggle("hidden");
      }

      function selectRes(w, h, btn) {
        currentRes = { w, h };
        document
          .querySelectorAll(".res-btn")
          .forEach(
            (b) =>
              (b.className =
                "res-btn bg-gray-800 hover:bg-gray-700 p-4 rounded-xl text-sm border border-gray-700 font-bold transition")
          );
        btn.className =
          "res-btn bg-blue-600 text-white p-4 rounded-xl text-sm border border-blue-500 shadow-lg font-bold";
      }
      function applyConfig() {
        currentFps = document.getElementById("fpsRange").value;
        toggleSettings();
        switchCamera(); // Restart stream with new config
      }

      // Focus Logic
      function checkFocus(t) {
        const c = t.getCapabilities ? t.getCapabilities() : {};
        document
          .getElementById("focusPanel")
          .classList.toggle("hidden", !c.focusMode);
      }
      function manualFocus(v) {
        localStream
          .getVideoTracks()[0]
          .applyConstraints({
            advanced: [{ focusMode: "manual", focusDistance: parseFloat(v) }],
          })
          .catch(() => {});
      }
      function setFocusMode(m) {
        localStream
          .getVideoTracks()[0]
          .applyConstraints({ advanced: [{ focusMode: m }] })
          .catch(() => {});
      }

      // OBS Link
      function initObsLink() {
        document.getElementById("obsUrlInput").value =
          window.location.origin + "/obs";
      }
      function copyObsLink() {
        navigator.clipboard
          .writeText(document.getElementById("obsUrlInput").value)
          .then(() => alert("Link Copied!"));
      }

      // --- 5. WEBRTC SIGNALING ---
      socket.on("ready", () => {
        if (isStreaming) createOffer();
      });

      async function createOffer() {
        if (peerConnection) peerConnection.close();
        peerConnection = new RTCPeerConnection(rtcConfig);
        localStream
          .getTracks()
          .forEach((t) => peerConnection.addTrack(t, localStream));

        setCodecPreferences(peerConnection); // Force AV1/VP9

        peerConnection.onicecandidate = (e) => {
          if (e.candidate)
            socket.emit("candidate", { candidate: e.candidate, room: room });
        };
        const offer = await peerConnection.createOffer();
        offer.sdp = setMediaBitrate(offer.sdp, 100000); // Force 100Mbps
        await peerConnection.setLocalDescription(offer);
        socket.emit("offer", { offer, room });
      }

      socket.on("answer", async (d) => {
        if (peerConnection) await peerConnection.setRemoteDescription(d.answer);
      });
      socket.on("candidate", async (d) => {
        if (peerConnection) await peerConnection.addIceCandidate(d.candidate);
      });

      function startBitrateCheck() {
        let lB = 0,
          lT = 0;
        setInterval(async () => {
          if (!peerConnection) return;
          const stats = await peerConnection.getStats(null);
          stats.forEach((r) => {
            if (r.type === "outbound-rtp" && r.kind === "video") {
              const now = r.timestamp,
                b = r.bytesSent;
              if (lT)
                document.getElementById("bitrate").innerText = Math.floor(
                  (8 * (b - lB)) / (now - lT)
                );
              lB = b;
              lT = now;
            }
          });
        }, 1000);
      }

      init();
    </script>
  </body>
</html>
